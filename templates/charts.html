<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-with, initial-scale=1.0">
    <title>My first webpage</title>

    <!---link naar CSS opmaak--->
    <link rel="stylesheet" type="text/css" href="../static/bootstrap/css/style_charts.css">

    <!---boxicons link--->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <!----remixicons link--->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

    <!---google fonts link --->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Poppins:ital,wght@1,300&display=swap"
        rel="stylesheet">
</head>


<body>

    <!-- chart.js link -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- om de schaal van tijd te maken -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1.3.1"></script>

    <!-- scrollreveal effect -->
    <script src="https://unpkg.com/scrollreveal"></script>

    <!-- custom javascript link -->
    <script src="../static/bootstrap/js/script.js"></script>

    <!-- javascript voor de grafiekjes, werkt niet doordat er variabelen nodig zijn uit de HTML file -->
    <!-- <script src="../static/bootstrap/js/charts_script.js"></script> -->
    <script src="{{url_for('static', filename='/bootstrap/js/charts_script.js')}}"></script>

    <!-- voor ajax functionaliteit -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>



    <header>
        <a href={{ url_for('index') }} class="logo">Binnenklimaat condities</a>
        <ul class="navlist">
            <li><a href={{ url_for('index') }}>ACTUELE DATA</a></li>
            <li><a href={{ url_for('charts') }}>GESCHIEDENIS</a></li>
            <li><a href={{ url_for('lege_pagina') }}>NOTIFICATIES</a></li>
            <li><a href={{ url_for('lege_pagina') }}>LEGE PAGINA</a></li>
        </ul>
        <div class="bx bx-menu" id="menu-icon"></div>
    </header>


    <div class="backgroundimage">

        <div class="block_container">
            <div class="plategrond">
                <div class="plategrond-text">
                    <h5>dit is de text</h5>
                </div>
                <div class="plategrond-image">
                    <img src="../static/images/plategrond2.png"
                        alt="Plattegrond van de 4e verdieping van de Hogeschool Utrecht Heidelberglaan 15">
                </div>
            </div>
            <div class="notification">
                <h5>nog wat test text</h5>
            </div>
        </div>



        <div class="block_container">
            <div class="temp">
                <div class="temp_text">
                    <h5>hier de text</h5>
                </div>
                <div class="temp_chart">
                    <canvas id="temp_chart"></canvas>
                </div>
                <div class="temp_buttons">
                    <button type="submit" id="button_10" name="button" onclick="updateGraph(10)" class="btn btn-primary">10</button>
                    <button type="submit" id="button_50" name="button" onclick="updateGraph(50)" class="btn btn-primary">50</button>
                    <button type="submit" id="button_100" name="button" onclick="updateGraph(100)"
                        class="btn btn-primary">100</button>
                    <div>
                        <input type="range" min="1" max="100" value="10" class="slider" id="myRange"
                            oninput="updateGraph(value)"></input>
                    </div>
                </div>
            </div>
            <div class="CO2">
                <div class="CO2_text">
                    <h5>Hier de text</h5>
                </div>
                <div class="CO2_chart">
                    <canvas id="co2_chart"></canvas>
                </div>
            </div>

        </div>
    </div>




    <script>
        const temp_chart = document.getElementById('temp_chart');

        time_labels = {{ get_recent_sensor_readings(0, 100) | safe }}
        time_luxon = []
        for (dt of time_labels) {
            time_luxon.push(luxon.DateTime.fromISO(dt))
        }
        temp_data = {{ get_recent_sensor_readings(1, 100) | safe }}

        var chart = new Chart(temp_chart, {
            type: 'line',
            data: {
                labels: time_luxon,
                datasets: [{
                    label: 'Temperature',
                    data: temp_data,                            // de data die je laat zien
                    backgroundColor: 'rgb(200, 240, 200)',      // vul kleur van de boletjes en blokjes
                    borderColor: 'rgb(40, 180, 20)',            // keur van de lijn
                    fill: false,                                // de onderkant vullen
                    cubicInterpolationMode: 'monotone',         // de vorm van de lijn afronden
                    tension: 0.4,                               // hoeveel er word afgerond
                    borderWidth: 1                              // dikte van de lijn
                }]
            },
            options: {
                responsive: true,
                animation: false,
                interaction: {
                    intersect: false,
                },
                scales: {
                    x: { display: true, title: { display: true }, type: 'time', time: { displayFormats: { hour: "dd/LL HH'h'", } } },
                    y: { display: true, title: { display: true, text: 'Degrees celsius (Â°C)' }, suggestedMin: 20, suggestedMax: 30, }
                    // x: { type: 'time', time: { displayFormats: { hour: "dd/LL HH'h'", } } },
                    // y: { suggestedMin: 20, suggestedMax: 30, }
                }
            }
        });


        const ct2 = document.getElementById('co2_chart');
        // time_labels = {{ get_recent_sensor_readings(0, 100) | safe }}
        // time_luxon = []
        // for (dt of time_labels) {
        //     time_luxon.push(luxon.DateTime.fromISO(dt))
        // }
        co2_data = {{ get_recent_sensor_readings(2, 100) | safe }}

        chart2 = new Chart(ct2, {
            type: 'line',
            data: {
                labels: time_luxon,
                datasets: [{
                    label: 'CO2 (ppm)',
                    borderColor: '#FF396A',
                    backgroundColor: '#FF396A80',
                    data: co2_data,
                    borderWidth: 1
                }]
            },
            options: {
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: "dd/LL HH'h'",
                            }
                        }
                    },
                    y: {
                        suggestedMin: 400,
                        suggestedMax: 1000,
                    }
                }
            }
        });


        // function to update the graph with new data
        function updateGraph(index) {
            document.getElementById('myRange').value=index
            // update the chart data
            chart.data.datasets[0].data = temp_data.slice(0, index);
            chart.data.labels = time_labels.slice(0, index);
            chart2.data.datasets[0].data = co2_data.slice(0, index);
            chart2.data.labels = time_labels.slice(0, index);
            // update the chart
            chart.update();
            chart2.update();
        }
        updateGraph(10);
    </script>









</body>

<script>

    function prepend(value, array) {
        var newArray = array.slice();
        newArray.unshift(value);
        return newArray;
    }

    function getNewData(location) {
        console.log(time_labels[0]);
        $.ajax({
            url: "{{url_for('get_new_data')}}",
            type: "GET",
            data: {'last_datapoint':time_labels[0], 'location':location},
            success: function(ret_data) {
                if (ret_data) {
                    console.log(ret_data);
                    console.log(ret_data['timestamp'].length);
                    for (var i = 0; i < ret_data['timestamp'].length; i++) {
                        console.log(ret_data['data'][i]);
                        console.log(ret_data['timestamp'][i]);
                        chart.data.datasets[0].data = prepend(ret_data['data']['temperature'][i], chart.data.datasets[0].data);
                        chart.data.labels = prepend(luxon.DateTime.fromISO(ret_data['timestamp'][i]), chart.data.labels);
                        chart.data.datasets[0].data.pop();
                        chart.data.labels.pop();
                        chart2.data.datasets[0].data = prepend(ret_data['data']['co2'][i], chart2.data.datasets[0].data);
                        chart2.data.labels = prepend(luxon.DateTime.fromISO(ret_data['timestamp'][i]), chart2.data.labels);
                        chart2.data.datasets[0].data.pop();
                        chart2.data.labels.pop();
                        time_labels = prepend(ret_data['timestamp'][i], time_labels);
                    }
                    chart.update();
                    chart2.update();
                }
            }
        });
    }
    
    myInterval = setInterval(function(){getNewData(1)}, 1000);

</script>

</html>